---
import Chevron from './icons/Chevron.svg';

const current = Astro.url.pathname;
const isActive = (path: string) => current === path;
---

<button class="menu-toggle" aria-expanded="false" aria-controls="mega" data-menu-btn>
    Explore <Chevron />
</button>

<div class="megamenu" id="mega" data-megamenu>
    <nav role="menubar" aria-label="Main navigation">
        <a
            href="/about/"
            role="menuitem"
            aria-current={isActive('/about/') ? 'page' : undefined}
        >
            <h4>About</h4>
            <p class="desc">Let me indulge and tell you a story</p>
        </a>
        <a href="/bag/" role="menuitem" aria-current={isActive('/bag/') ? 'page' : undefined}>
            <h4>Bag</h4>
            <p class="desc">Desk setup and other main daily uses</p>
        </a>
        <a href="/blog/" role="menuitem" aria-current={isActive('/blog/') ? 'page' : undefined}>
            <h4>Blog</h4>
            <p class="desc">More or less coherent and long-form thoughts</p>
        </a>
        <a
            href="/site-info/"
            role="menuitem"
            aria-current={isActive('/site-info/') ? 'page' : undefined}
        >
            <h4>Site info</h4>
            <p class="desc">Info about this site and some transparency</p>
        </a>
    </nav>
</div>

<style>
    a:hover {
        text-decoration: none;
    }
    button.menu-toggle {
        display: flex;
        gap: 0.25rem;
        align-items: center;
        color: var(--text-secondary);
        margin-right: var(--space-1);
        font-family: var(--font-heading);
        font-weight: 500;
    }

    button.menu-toggle svg {
        stroke-width: 2.2;
        transition: transform 0.09s cubic-bezier(0.25, 0.8, 0.3, 1);
    }

    button.menu-toggle:hover svg {
        color: var(--accent-primary);
    }

    button.menu-toggle:active svg {
        transform: scaleX(0.7);
    }

    /* Mobile-first: base styles */
    .megamenu {
        width: 100%;
        max-width: 100%;
        height: calc(100dvh - var(--header-height));
        right: 0;
        z-index: 1;
        position: absolute;
        top: var(--header-height);
        opacity: 1;
        transition: opacity 0.28s var(--cubic-snappy);
    }

    .megamenu:not(.open) {
        opacity: 0;
        pointer-events: none;
    }

    /* 536px width of mega menu + 2*space, on desktop */
    @media (max-width: 559px) {
        body.noscroll {
            overflow: hidden;
            touch-action: none;
        }
    }

    nav {
        padding: var(--space-3);
        background: var(--bg-secondary);
        display: flex;
        gap: var(--space-3);
        height: 100%;
        flex-direction: column;
        align-items: flex-end;
    }
    h4 {
        font-size: 1.4rem;
    }
    nav h4,
    nav p {
        margin: 0;
    }

    nav a {
        color: var(--text-primary);
    }

    nav p.desc {
        display: none;
    }

    /* Desktop overrides */
    /* 536px width of mega menu + 2* var(--layout-padding)/32px, on desktop */
    @media (min-width: 560px) {
        .megamenu {
            width: 31rem;
            height: auto;
            margin-top: -0.0625rem;
            right: auto;
        }

        nav {
            display: grid;
            height: auto;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-0);
            border-radius: var(--radius-md);
            border: var(--1px) solid var(--border-primary);
            opacity: 1;
            transform: rotateX(0) scale(1);
            transform-origin: top right;
            transition:
                border-radius 0.28s var(--cubic-snappy),
                transform 0.28s var(--cubic-snappy);
        }
        .megamenu:not(.open) nav {
            transform: rotateX(-15deg) scale(0.9);
        }

        :global(header.top.scrolled nav) {
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }

        nav a {
            padding: var(--space-2);
            border-radius: var(--radius-sm);
            border: var(--1px) solid var(--bg-secondary);
            will-change: transform;
            transform: translateZ(0);
        }

        nav a:hover {
            border-color: var(--border-secondary);
            background-color: var(--bg-alt);
        }
        h4 {
            font-weight: 600;
            font-size: var(--h4);
        }
        nav a:hover h4 {
            color: var(--accent-primary);
        }

        nav p.desc {
            display: block;
            font-size: var(--p-sm);
        }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
        .megamenu {
            transition: opacity 0.001s linear;
            transform: none;
        }

        .megamenu:not(.open) {
            opacity: 0;
            transform: none;
        }

        button.menu-toggle:active svg {
            transform: none;
        }
    }
</style>

<script src="/scripts/megamenu.js" defer></script>
