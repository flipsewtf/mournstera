---
import { Chevron } from '../components/icons';

const current = Astro.url.pathname;
const isActive = (path: string) => current === path;
---

<button
    class="menu-toggle"
    aria-expanded="false"
    aria-controls="mega"
    aria-haspopup="menu"
    data-menu-btn>
    <span class="mobile">Menu</span>
    <span class="desktop">Explore</span>
    <Chevron />
</button>

<div class="megamenu" id="mega" data-megamenu>
    <nav aria-label="Main navigation">
        <a
            href="/about/"
            aria-current={isActive('/about/') ? 'page' : undefined}
            aria-describedby="about-desc">
            <h4>About</h4>
            <p class="desc" id="about-desc">A peek into who I am and most of the whys.</p>
        </a>

        <a
            class="mobile"
            href="/blog/"
            aria-current={isActive('/blog/') ? 'page' : undefined}
            aria-describedby="blog-desc">
            <h4>Blog</h4>
            <p class="desc" id="blog-desc">More-or-less coherent thought-out posts.</p>
        </a>

        <a
            class="mobile"
            href="/garden/"
            aria-current={isActive('/garden/') ? 'page' : undefined}
            aria-describedby="garden-desc">
            <h4>Garden</h4>
            <p class="desc" id="garden-desc">Notes, ideas, musings, thoughts in progress.</p>
        </a>

        <a
            href="/cozy-corner/"
            aria-current={isActive('/cozy-corner/') ? 'page' : undefined}
            aria-describedby="cozycorner-desc">
            <h4>Cozy Corner</h4>
            <p class="desc" id="cozycorner-desc">A list of the gear I use for my cozy workspace.</p>
        </a>
        <a
            href="/colophon/"
            aria-current={isActive('/colophon/') ? 'page' : undefined}
            aria-describedby="colophon-desc">
            <h4>Colophon</h4>
            <p class="desc" id="colophon-desc">Read about build, credits and policy.</p>
        </a>
    </nav>
</div>

<style>
    a {
        color: var(--text);
        text-decoration: none;
    }
    a:hover {
        color: var(--purple-accent);
    }

    button.menu-toggle {
        display: flex;
        gap: var(--px4);
        align-items: center;
        color: var(--text-alt);
        font-weight: 600;
        transition:
            color var(--cubic-smooth),
            text-decoration-color var(--cubic-smooth);

        svg {
            color: var(--text-alt);
            width: var(--text-sm);
            height: var(--text-sm);
            fill: currentColor;
            margin-top: var(--px1);
            transition: transform var(--cubic-snappy);
        }
    }

    button.menu-toggle:hover {
        color: var(--purple-accent);
    }

    button.menu-toggle.pressed svg {
        transform: rotateZ(-180deg);
    }

    /* Mobile-first: base styles */
    .megamenu {
        width: 100%;
        max-width: 100%;
        height: calc(100dvh - var(--header-height));
        right: 0;
        z-index: 1;
        position: absolute;
        top: var(--header-height);
        opacity: 1;
        transition: opacity var(--cubic-snappy);
    }

    .megamenu:not(.open) {
        opacity: 0;
        pointer-events: none;
    }

    body.noscroll {
        overflow: hidden;
        touch-action: none;
    }

    nav {
        padding: var(--space-3);
        background: var(--bg-alt);
        display: flex;
        gap: var(--space-3);
        height: 100%;
        flex-direction: column;
        align-items: flex-end;
        justify-content: flex-end;
    }
    @media (min-width: 440px) {
        nav {
            justify-content: flex-start;
        }
    }

    h4 {
        font-size: 1.4rem;
        margin: 0;
        transition: inherit;
        font-weight: 700;
    }
    nav a:hover h4 {
        color: var(--purple-accent);
    }

    nav p.desc {
        display: none;
    }
    /* Desktop overrides */
    @media (min-width: 960px) {
        .megamenu {
            max-width: calc(var(--layout-width) - var(--layout-padding) * 2);
            margin: 0 var(--layout-padding);
        }
    }

    @media (min-width: 768px) {
        .megamenu {
            width: calc(100% - var(--layout-padding) * 2);
            height: auto;
            margin: 0 auto;
            right: unset;
        }

        body.noscroll {
            overflow: auto;
            touch-action: auto;
        }

        nav {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            align-items: stretch;
            justify-items: start;
            gap: var(--space-0);
            height: auto;
            padding: var(--space-3);
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            border: var(--px1) solid var(--border);
            border-top: 0;
            opacity: 1;
            transform-origin: top left;
            will-change: transform;
            transform: scale(1) rotateX(0deg);
            backface-visibility: hidden;
            transition: transform var(--cubic-snappy);
        }

        .megamenu:not(.open) nav {
            transform: scale(0.94) rotateX(-15deg);
        }

        nav a {
            padding: var(--space-1);
            border-radius: var(--radius-sm);
            background-color: var(--bg-alt);
        }

        h4 {
            font-size: var(--h4);
            transition: inherit;
        }

        nav p.desc {
            display: block;
            color: var(--text);
            font-size: var(--text-sm);
            line-height: var(--line-height-sub);
            margin: var(--px6) 0 0 0;
            transition: inherit;
        }

        nav a:hover {
            background-color: var(--purple-bg);

            p.desc {
                color: var(--text-alt);
            }
        }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
        .megamenu {
            transition: opacity 0.04s linear;
        }

        button.menu-toggle:active svg,
        .megamenu:not(.open) nav {
            transform: none;
            transition: none;
        }
    }
</style>

<script src="/scripts/megamenu.js" defer></script>
